# Copyright 2012-2013 UT-Battelle, LLC.  See LICENSE.txt for more information.
CXX=g++
FLEX=flex
BISON=bison
RM=rm -f
AR=ar

CPPFLAGS=-I../src
CXXFLAGS=-g -O0 -Wall -Werror=return-type
LDFLAGS=
LIBS=-L../lib -laspen
LIBDEP=../lib/libaspen.a
HDRDEP=../src/*.h

#\todo: these should be generated by autoconf
CXXFLAGS += -DHAVE_CXXABI_H
LDFLAGS += -rdynamic

OBJ=$(SRC:.cpp=.o) $(LSRC:.l=.o) $(YSRC:.y=.o)

TESTS=\
 bigtest \
 dual_tradeoff \
 export \
 kernelmemusageexclusive \
 kernelmemusageinclusive \
 parsestring \
 resourcecount \
 resourcematch \
 roofline \
 runtime \
 singlemapmemusage \
 smallmodeltest \
 tradeoff

all: $(TESTS)
	@echo ""
	@echo "Run 'make check' to run validation tests."
	@echo ""

# programs

resourcecount: $(LIBDEP) $(HDRDEP) resourcecount.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

resourcematch: $(LIBDEP) $(HDRDEP) resourcematch.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

runtime: $(LIBDEP) $(HDRDEP) runtime.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

smallmodeltest: $(LIBDEP) $(HDRDEP) smallmodeltest.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

bigtest: $(LIBDEP) $(HDRDEP) bigtest.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

parsestring: $(LIBDEP) $(HDRDEP) parsestring.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

roofline: $(LIBDEP) $(HDRDEP) roofline.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

export: $(LIBDEP) $(HDRDEP) export.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

tradeoff: $(LIBDEP) $(HDRDEP) tradeoff.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

dual_tradeoff: $(LIBDEP) $(HDRDEP) dual_tradeoff.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

kernelmemusageexclusive: $(LIBDEP) $(HDRDEP) kernelmemusageexclusive.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

kernelmemusageinclusive: $(LIBDEP) $(HDRDEP) kernelmemusageinclusive.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

singlemapmemusage: $(LIBDEP) $(HDRDEP) singlemapmemusage.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(LDFLAGS) $(@:=.cpp) -o $@ $(LIBS)

# test code

.cpp.o:
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -c $<

clean distclean:
	$(RM) $(TESTS)
	$(RM) diffs.sh results.txt rebaseline.sh
	$(RM) current/*/*.out
	$(RM) current/*/*.err

check test: $(TESTS)
	@if test -z `which python`; then \
	   echo "Warning; need python to run full test suite"; \
	else \
	   echo "== Running tests =="; \
	   python runtest.py; \
	fi

