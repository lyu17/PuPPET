# Copyright 2012-2013 UT-Battelle, LLC.  See LICENSE.txt for more information.
CXX=g++
FLEX=flex
BISON=bison
RM=rm -f
AR=ar

CPPFLAGS=
CXXFLAGS=-g -O0 -Wall -Werror=return-type
LDFLAGS=

#\todo: these should be generated by autoconf
CXXFLAGS += -DHAVE_CXXABI_H
LDFLAGS += -rdynamic

LIB=../lib/libaspen.a
LSRC=AspenTokens.l
YSRC=AspenParser.y
SRC=ASTKernel.cpp ASTControlStatement.cpp ASTAppModel.cpp ASTMachModel.cpp Parser.cpp ASTExecutionBlock.cpp ASTExpression.cpp
OBJ=$(SRC:.cpp=.o) $(LSRC:.l=.o) $(YSRC:.y=.o)

all: $(LIB)

.SUFFIXES: .y .l .cpp .o .d

$(LIB): $(OBJ)
	$(AR) -rcs $@ $(OBJ)

.cpp.o:
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) -c $<

AspenParser.cpp: $(YSRC)
	$(BISON) -d -r all -o $(YSRC:.y=.cpp) $(YSRC)

AspenParser.hpp: AspenParser.cpp

AspenTokens.cpp: $(LSRC) AspenParser.hpp
	$(FLEX) -o $@ $(LSRC)

clean:
	$(RM) $(LIB) $(OBJ) main.o

distclean realclean: clean
	$(RM) $(DEP)
	$(RM) $(LSRC:.l=.cpp)
	$(RM) $(YSRC:.y=.hpp) $(YSRC:.y=.cpp)
	$(RM) $(YSRC:.y=.output)

# dependencies
.cpp.d:
	@echo "updating $@"; rm -f $@; \
	$(CXX) -M $(CPPFLAGS) $< | sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' > $@;

DEP:=$(OBJ:.o=.d)
-include $(DEP)
